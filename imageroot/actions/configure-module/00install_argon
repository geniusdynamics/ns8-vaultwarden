#!/usr/bin/env python3

#
# Copyright (C) 2023 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#


import subprocess
import sys


def upgrade_pip():
    try:
        subprocess.run(
            [sys.executable, "-m", "pip", "install", "--upgrade", "pip"], check=True
        )
        print("‚úÖ pip upgraded successfully.")
    except subprocess.CalledProcessError as e:
        print(f"‚ö†Ô∏è Failed to upgrade pip: {e}")


def install_argon2():
    try:
        subprocess.run(
            [sys.executable, "-m", "pip", "install", "--quiet", "argon2-cffi"],
            check=True,
        )
        print("‚úÖ argon2-cffi installed successfully.")
    except subprocess.CalledProcessError as e:
        print(f"‚ùå Failed to install argon2-cffi: {e}")
        sys.exit(1)


# Try importing first
try:
    from argon2 import PasswordHasher

    print("‚úÖ argon2-cffi is already installed.")
except ImportError:
    print("üì¶ argon2-cffi not found. Installing...")
    upgrade_pip()
    install_argon2()
    # Retry import after installation
    try:
        from argon2 import PasswordHasher

        print("‚úÖ argon2-cffi import successful after installation.")
    except ImportError:
        print("‚ùå Still unable to import argon2-cffi after installation.")
        sys.exit(1)
